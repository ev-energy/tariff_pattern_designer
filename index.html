<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Tariff Pattern Designer (React)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        // Import the date-holidays library using its ESM endpoint
        // and assign the default export (the Holidays class) to the global window object.
        import HolidaysESM from 'https://cdn.jsdelivr.net/npm/date-holidays@3.24.3/+esm';
        window.Holidays = HolidaysESM; 
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar styling */
        #jsonOutputReact::-webkit-scrollbar, 
        .tariff-rules-container::-webkit-scrollbar, 
        .weekday-groups-container::-webkit-scrollbar,
        .holiday-month-rules-container::-webkit-scrollbar,
        .override-rules-container::-webkit-scrollbar,
        #fetchedHolidaysList::-webkit-scrollbar {
            width: 8px; height: 8px;
        }
        #jsonOutputReact::-webkit-scrollbar-track, 
        .tariff-rules-container::-webkit-scrollbar-track, 
        .weekday-groups-container::-webkit-scrollbar-track,
        .holiday-month-rules-container::-webkit-scrollbar-track,
        .override-rules-container::-webkit-scrollbar-track,
        #fetchedHolidaysList::-webkit-scrollbar-track {
            background: #f1f1f1; border-radius: 10px;
        }
        #jsonOutputReact::-webkit-scrollbar-thumb, 
        .tariff-rules-container::-webkit-scrollbar-thumb, 
        .weekday-groups-container::-webkit-scrollbar-thumb,
        .holiday-month-rules-container::-webkit-scrollbar-thumb,
        .override-rules-container::-webkit-scrollbar-thumb,
        #fetchedHolidaysList::-webkit-scrollbar-thumb {
            background: #888; border-radius: 10px;
        }
        #jsonOutputReact::-webkit-scrollbar-thumb:hover, 
        .tariff-rules-container::-webkit-scrollbar-thumb:hover, 
        .weekday-groups-container::-webkit-scrollbar-thumb:hover,
        .holiday-month-rules-container::-webkit-scrollbar-thumb:hover,
        .override-rules-container::-webkit-scrollbar-thumb:hover,
        #fetchedHolidaysList::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .label-cb { display: flex; align-items: center; cursor: pointer; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .section-container {
            border: 1px solid #d1d5db; border-radius: 0.75rem; padding: 1.5rem; 
            margin-bottom: 2rem; background-color: #ffffff; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }
        .section-header {
            font-size: 1.5rem; font-weight: 700; color: #1d4ed8; 
            margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #93c5fd;
        }
        
        .tariff-rule, .weekday-group, .holiday-month-rule, .override-rule {
            border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1.5rem; 
            margin-bottom: 1.5rem; background-color: #f9fafb;
        }
        .subsection-title {
            font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; 
            color: #374151; border-bottom: 1px solid #d1d5db; padding-bottom: 0.5rem;
        }
        .remove-btn {
             background-color: #ef4444; color: white; font-weight: 600; 
             padding: 0.5rem 0.75rem; border-radius: 0.375rem; font-size: 0.875rem;
        }
        .remove-btn:hover { background-color: #dc2626; }
        .add-btn {
            background-color: #22c55e; color: white; font-weight: 600;
            padding: 0.5rem 1rem; border-radius: 0.5rem;
        }
        .add-btn:hover { background-color: #16a34a; }
        
        #statusMessageReact { min-height: 2.5rem; display: flex; align-items: center; justify-content: center; } 
        .input-field {
            margin-top: 0.25rem; display: block; width: 100%; border-radius: 0.375rem; 
            border-color: #d1d5db; box-shadow: 0 1px 2px 0 rgba(0,0,0,0.05); 
            padding: 0.5rem 0.75rem; font-size: 0.875rem;
        }
        .input-label { display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 0.25rem;}

        .quick-start-btn {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            font-weight: 500; /* medium */
            padding: 0.625rem 1.25rem; /* py-2.5 px-5 */
            border-radius: 0.5rem; /* rounded-lg */
            transition: background-color 0.15s ease-in-out;
            box-shadow: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06);
        }
        .quick-start-btn:hover {
            background-color: #4338ca; /* indigo-700 */
        }
        #fetchedHolidaysList {
            max-height: 200px; /* Limit height and make scrollable */
            overflow-y: auto;
            background-color: #eef2ff; /* indigo-50 for slight contrast */
            padding: 0.75rem; /* p-3 */
            border-radius: 0.375rem; /* rounded-md */
            border: 1px solid #c7d2fe; /* indigo-200 */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 md:p-8">
    <div id="root"></div>

    <script type="text/babel" data-presets="react">
        const { useState, useEffect, useCallback, useMemo, useRef } = React;

        // --- Constants ---
        const MONTHS_DATA = [ 
            { name: "January", value: 1 }, { name: "February", value: 2 }, { name: "March", value: 3 }, 
            { name: "April", value: 4 }, { name: "May", value: 5 }, { name: "June", value: 6 }, 
            { name: "July", value: 7 }, { name: "August", value: 8 }, { name: "September", value: 9 }, 
            { name: "October", value: 10 }, { name: "November", value: 11 }, { name: "December", value: 12 }
        ];
        const WEEKDAYS_DATA = [ 
            { name: "Monday", value: 1 }, { name: "Tuesday", value: 2 }, { name: "Wednesday", value: 3 }, 
            { name: "Thursday", value: 4 }, { name: "Friday", value: 5 }, { name: "Saturday", value: 6 }, 
            { name: "Sunday", value: 7 } 
        ];
        const ALL_MONTH_NUMBERS = MONTHS_DATA.map(m => m.value);
        const ALL_WEEKDAY_NUMBERS = WEEKDAYS_DATA.map(wd => wd.value);
        const MINUTES_IN_DAY = 24 * 60;

        // --- Helper Functions ---
        const generateId = () => `id-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;

        const debounce = (func, delay) => {
            let timeout;
            return (...args) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => func(...args), delay);
            };
        };

        const timeStringToMinutes = (timeStr) => {
            if (!timeStr || typeof timeStr !== 'string' || !timeStr.includes(':')) return 0;
            const [hours, minutes] = timeStr.split(':').map(Number);
            return (hours * 60) + minutes;
        };

        const formatTimeForDisplay = (minutesTotal) => {
            const hours = Math.floor(minutesTotal / 60) % 24; 
            const minutes = minutesTotal % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        };

        // --- Reusable UI Components ---
        const CheckboxGroup = ({ items, selectedItems, onChange, allText, groupName }) => {
            const handleSelectAll = (e) => {
                const newSelectedItems = e.target.checked ? items.map(item => item.value) : [];
                onChange(newSelectedItems);
            };

            const handleItemChange = (itemValue, checked) => {
                const newSelectedItems = checked
                    ? [...selectedItems, itemValue]
                    : selectedItems.filter(value => value !== itemValue);
                onChange(newSelectedItems);
            };

            const areAllSelected = items.length > 0 && selectedItems.length === items.length;
            const areSomeSelected = selectedItems.length > 0 && !areAllSelected;

            return (
                <div>
                    <label className="label-cb text-gray-700 font-medium mb-2 block">
                        <input
                            type="checkbox"
                            className="mr-2 h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                            checked={areAllSelected}
                            ref={el => el && (el.indeterminate = areSomeSelected)} 
                            onChange={handleSelectAll}
                        />
                        {allText}
                    </label>
                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                        {items.map(item => (
                            <label key={`${groupName}-${item.value}`} className="label-cb text-sm text-gray-600 hover:text-blue-600">
                                <input
                                    type="checkbox"
                                    value={item.value}
                                    checked={selectedItems.includes(item.value)}
                                    className="mr-2 h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                                    onChange={(e) => handleItemChange(item.value, e.target.checked)}
                                />
                                {item.name}
                            </label>
                        ))}
                    </div>
                </div>
            );
        };

        const RatePeriod = ({ period, onChange, onRemove }) => {
            const [displayAmount, setDisplayAmount] = useState(period.amount.toString());

            useEffect(() => {
                const propAmountString = period.amount.toString();
                // Check if the parsed displayAmount is different from period.amount OR if the string representations differ
                // This helps avoid unnecessary updates if the user is typing "0.10" and period.amount is 0.1
                if (parseFloat(displayAmount) !== period.amount || (displayAmount !== propAmountString && displayAmount !== parseFloat(propAmountString).toString()) ) {
                     setDisplayAmount(propAmountString);
                }
            }, [period.amount]);


            const handleTimeChange = (e, field) => {
                let value = e.target.value;
                if (value) {
                    const [hStr, mStr] = value.split(':');
                    const h = parseInt(hStr, 10);
                    let m = parseInt(mStr, 10);
                    if (!isNaN(h) && !isNaN(m)) {
                         if (m !== 0 && m !== 30) {
                            m = (m < 15 || m >= 45) ? 0 : 30;
                            value = `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                        }
                    }
                }
                onChange({ ...period, [field]: value });
            };
            
            const handleAmountInputChange = (e) => {
                const stringValue = e.target.value;
                setDisplayAmount(stringValue); 

                const parsedNum = parseFloat(stringValue);
                if (stringValue === "" || stringValue === "-") { 
                    onChange({ ...period, amount: 0 }); 
                } else if (!isNaN(parsedNum)) {
                    onChange({ ...period, amount: parsedNum });
                }
            };

            return (
                <div className="p-3 border border-gray-200 rounded-md grid grid-cols-1 sm:grid-cols-7 gap-2 items-center bg-white shadow-sm text-sm">
                    <div className="sm:col-span-2 grid grid-cols-1 gap-1">
                        <label className="block text-xs font-medium text-gray-700">Start:</label>
                        <input 
                            type="time" 
                            value={period.start} 
                            onChange={(e) => handleTimeChange(e, 'start')}
                            className="input-field text-xs rate-start-time" 
                            step="1800" 
                        />
                    </div>
                    <div className="sm:col-span-2 grid grid-cols-1 gap-1">
                        <label className="block text-xs font-medium text-gray-700">End:</label>
                        <input 
                            type="time" 
                            value={period.end} 
                            onChange={(e) => handleTimeChange(e, 'end')}
                            className="input-field text-xs rate-end-time" 
                            step="1800"
                        />
                    </div>
                    <div className="sm:col-span-2 grid grid-cols-1 gap-1">
                        <label className="block text-xs font-medium text-gray-700">Amount:</label>
                        <input 
                            type="number" 
                            step="0.0001" 
                            value={displayAmount} 
                            onChange={handleAmountInputChange}
                            min="0" 
                            className="input-field text-xs rate-amount" 
                        />
                    </div>
                    <button 
                        onClick={onRemove}
                        className="sm:col-span-1 remove-btn text-xs h-8 self-center mt-2 sm:mt-0"
                    >
                        Remove
                    </button>
                </div>
            );
        };

        const WeekdayGroup = ({ group, ruleContext, onUpdateGroup, onRemoveGroup }) => {
            const handleWeekdayChange = (selectedWeekdays) => {
                onUpdateGroup({ ...group, weekdays: selectedWeekdays });
            };

            const addRatePeriod = () => {
                const newPeriod = { id: generateId(), start: "00:00", end: "00:00", amount: 0.00 };
                onUpdateGroup({ ...group, ratePeriods: [...group.ratePeriods, newPeriod] });
            };

            const updateRatePeriod = (updatedPeriod) => {
                onUpdateGroup({
                    ...group,
                    ratePeriods: group.ratePeriods.map(p => p.id === updatedPeriod.id ? updatedPeriod : p)
                });
            };

            const removeRatePeriod = (periodId) => {
                onUpdateGroup({
                    ...group,
                    ratePeriods: group.ratePeriods.filter(p => p.id !== periodId)
                });
            };

            return (
                <div className="weekday-group ml-0 md:ml-6">
                    <div className="flex justify-between items-center mb-4">
                        <h4 className="text-md font-medium text-green-700">Weekday Group (within {ruleContext})</h4>
                        <button onClick={onRemoveGroup} className="remove-btn text-xs">Remove Weekday Group</button>
                    </div>
                    <section className="mb-4">
                        <h5 className="subsection-title text-sm">Weekdays for this Group (ISO)</h5>
                        <CheckboxGroup
                            items={WEEKDAYS_DATA}
                            selectedItems={group.weekdays}
                            onChange={handleWeekdayChange}
                            allText="Select All Weekdays"
                            groupName={`weekdays-${group.id}`}
                        />
                    </section>
                    <div className="rate-periods-container space-y-3">
                        <h5 className="subsection-title text-sm">Rate Time Ranges</h5>
                        {group.ratePeriods.map(period => (
                            <RatePeriod 
                                key={period.id} 
                                period={period}
                                onChange={(updatedPeriod) => updateRatePeriod(updatedPeriod)}
                                onRemove={() => removeRatePeriod(period.id)}
                            />
                        ))}
                    </div>
                    <button onClick={addRatePeriod} className="add-btn text-xs add-rate-period-btn mt-3">
                        + Add Rate Period
                    </button>
                </div>
            );
        };

        const MonthRuleSet = ({ rule, type, onUpdateRule, onRemoveRule }) => { 
            const titlePrefix = type === 'standard' ? 'Standard Tariff Rule' : 'Holiday Month Rule';
            const ruleContext = `${titlePrefix} #${rule.number}`;

            const handleMonthChange = (selectedMonths) => {
                onUpdateRule({ ...rule, months: selectedMonths });
            };

            const addWeekdayGroup = () => {
                const newGroup = { id: generateId(), weekdays: [], ratePeriods: [{ id: generateId(), start: "00:00", end: "00:00", amount: 0.00 }] };
                onUpdateRule({ ...rule, weekdayGroups: [...rule.weekdayGroups, newGroup] });
            };

            const updateWeekdayGroup = (updatedGroup) => {
                onUpdateRule({
                    ...rule,
                    weekdayGroups: rule.weekdayGroups.map(g => g.id === updatedGroup.id ? updatedGroup : g)
                });
            };

            const removeWeekdayGroup = (groupId) => {
                onUpdateRule({
                    ...rule,
                    weekdayGroups: rule.weekdayGroups.filter(g => g.id !== groupId)
                });
            };
            
            const ruleBgClass = type === 'holiday' ? 'bg-blue-50' : '';

            return (
                <div className={`tariff-rule ${ruleBgClass}`}>
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-lg font-medium text-blue-700">{ruleContext}</h3>
                        <button onClick={onRemoveRule} className="remove-btn">Remove Rule</button>
                    </div>
                    <section className="mb-4">
                        <h4 className="subsection-title text-md">Months for this Rule</h4>
                        <CheckboxGroup
                            items={MONTHS_DATA}
                            selectedItems={rule.months}
                            onChange={handleMonthChange}
                            allText="Select All Months"
                            groupName={`months-${rule.id}`}
                        />
                    </section>
                    <div className="weekday-groups-container space-y-4 mb-4">
                        {rule.weekdayGroups.map(group => (
                            <WeekdayGroup 
                                key={group.id} 
                                group={group}
                                ruleContext={ruleContext}
                                onUpdateGroup={updateWeekdayGroup}
                                onRemoveGroup={() => removeWeekdayGroup(group.id)}
                            />
                        ))}
                    </div>
                    <button onClick={addWeekdayGroup} className="add-btn text-sm add-weekday-group-btn">
                        + Add Weekday Group
                    </button>
                </div>
            );
        };

        const OverrideDateEntry = ({ entry, onChange, onRemove }) => {
            return (
                <div className="grid grid-cols-1 sm:grid-cols-3 gap-2 items-end">
                    <div>
                        <label className="input-label text-xs">Month (1-12):</label>
                        <input 
                            type="number" min="1" max="12" 
                            value={entry.month} 
                            onChange={(e) => onChange({ ...entry, month: parseInt(e.target.value) || '' })}
                            className="input-field text-xs override-month" placeholder="e.g., 12" 
                        />
                    </div>
                    <div>
                        <label className="input-label text-xs">Day(s) (comma-separated):</label>
                        <input 
                            type="text" 
                            value={entry.days.join(',')} 
                            onChange={(e) => onChange({ ...entry, days: e.target.value.split(',').map(d => parseInt(d.trim())).filter(d => !isNaN(d)) })}
                            className="input-field text-xs override-days" placeholder="e.g., 25,31" 
                        />
                    </div>
                    <button onClick={onRemove} className="remove-btn text-xs h-8 self-center sm:self-end">Remove Date</button>
                </div>
            );
        };

        const OverrideRule = ({ rule, onUpdateRule, onRemoveRule }) => {
            const addDateEntry = () => {
                const newDateEntry = { id: generateId(), month: '', days: [] };
                onUpdateRule({ ...rule, dates: [...rule.dates, newDateEntry] });
            };
            const updateDateEntry = (updatedEntry) => {
                onUpdateRule({ ...rule, dates: rule.dates.map(d => d.id === updatedEntry.id ? updatedEntry : d) });
            };
            const removeDateEntry = (entryId) => {
                onUpdateRule({ ...rule, dates: rule.dates.filter(d => d.id !== entryId) });
            };

            const addRatePeriod = () => {
                const newPeriod = { id: generateId(), start: "00:00", end: "00:00", amount: 0.00 };
                onUpdateRule({ ...rule, ratePeriods: [...rule.ratePeriods, newPeriod] });
            };
            const updateRatePeriod = (updatedPeriod) => {
                onUpdateRule({ ...rule, ratePeriods: rule.ratePeriods.map(p => p.id === updatedPeriod.id ? updatedPeriod : p) });
            };
            const removeRatePeriod = (periodId) => {
                onUpdateRule({ ...rule, ratePeriods: rule.ratePeriods.filter(p => p.id !== periodId) });
            };

            return (
                <div className="override-rule bg-purple-50">
                    <div className="flex justify-between items-center mb-4">
                        <h3 className="text-lg font-medium text-purple-700">Override Rule #{rule.number}</h3>
                        <button onClick={onRemoveRule} className="remove-btn">Remove Override Rule</button>
                    </div>
                    <div className="mb-4">
                        <h4 className="subsection-title text-md">Specific Dates for this Override</h4>
                        <div className="override-dates-container space-y-2 mb-3">
                            {rule.dates.map(entry => (
                                <OverrideDateEntry 
                                    key={entry.id} 
                                    entry={entry}
                                    onChange={updateDateEntry}
                                    onRemove={() => removeDateEntry(entry.id)}
                                />
                            ))}
                        </div>
                        <button onClick={addDateEntry} className="add-btn text-xs add-override-date-btn">
                            + Add Month/Day(s)
                        </button>
                    </div>
                    <div>
                        <h4 className="subsection-title text-md">Rate for these Override Dates</h4>
                        <div className="override-rate-periods-container space-y-3">
                             {rule.ratePeriods.map(period => (
                                <RatePeriod 
                                    key={period.id} 
                                    period={period}
                                    onChange={updateRatePeriod}
                                    onRemove={() => removeRatePeriod(period.id)}
                                />
                            ))}
                        </div>
                        <button onClick={addRatePeriod} className="add-btn text-xs add-override-rate-btn mt-3">
                            + Add Rate Period
                        </button>
                    </div>
                </div>
            );
        };

        const RatePreviewChart = ({ chartData, selectedWeekStartForChart }) => { // Added selectedWeekStartForChart prop
            const chartRef = useRef(null);
            const chartInstanceRef = useRef(null); 

            useEffect(() => {
                if (chartRef.current && chartData && typeof Chart !== 'undefined' && selectedWeekStartForChart) { 
                    if (chartInstanceRef.current) {
                        chartInstanceRef.current.destroy(); 
                    }
                    const ctx = chartRef.current.getContext('2d');
                    chartInstanceRef.current = new Chart(ctx, {
                        type: 'line', 
                        data: {
                            labels: chartData.labels,
                            datasets: [{
                                label: 'Rate (£)',
                                data: chartData.data,
                                borderColor: 'rgb(75, 192, 192)',
                                backgroundColor: 'rgba(75, 192, 192, 0.5)',
                                tension: 0.1,
                                stepped: 'before', 
                                pointRadius: 0, 
                                borderWidth: 2,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: { 
                                mode: 'index',
                                intersect: false,
                                axis: 'x'
                            },
                            scales: {
                                x: {
                                    title: { display: true, text: 'Time of Week' },
                                    ticks: { autoSkip: true, maxTicksLimit: 24 }
                                },
                                y: {
                                    title: { display: true, text: 'Rate Amount (£)' },
                                    beginAtZero: true,
                                     ticks: { callback: function(value) { return '£' + value.toFixed(2); } }
                                }
                            },
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        title: function(tooltipItems) {
                                            if (!tooltipItems.length) return '';
                                            const dataIndex = tooltipItems[0].dataIndex;
                                            const dayOffset = Math.floor(dataIndex / 48);
                                            const minutesIntoDay = (dataIndex % 48) * 30;

                                            const baseDate = new Date(selectedWeekStartForChart + "T00:00:00"); // Ensure local timezone
                                            const currentDate = new Date(baseDate.setDate(baseDate.getDate() + dayOffset));
                                            
                                            currentDate.setHours(Math.floor(minutesIntoDay / 60));
                                            currentDate.setMinutes(minutesIntoDay % 60);
                                            
                                            const options = { weekday: 'long', year: 'numeric', month: '2-digit', day: '2-digit' };
                                            const formattedDate = currentDate.toLocaleDateString('en-GB', options);
                                            const formattedTime = `${String(currentDate.getHours()).padStart(2, '0')}:${String(currentDate.getMinutes()).padStart(2, '0')}`;
                                            return `${formattedDate} ${formattedTime}`;
                                        },
                                        label: function(tooltipItem) { return `Rate: £${Number(tooltipItem.raw).toFixed(4)}`; }
                                    }
                                }
                            }
                        }
                    });
                }
                return () => {
                    if (chartInstanceRef.current) {
                        chartInstanceRef.current.destroy();
                        chartInstanceRef.current = null;
                    }
                };
            }, [chartData, selectedWeekStartForChart]); 

            return (
                <div className="relative h-96"> 
                    <canvas ref={chartRef}></canvas>
                </div>
            );
        };


        // --- Main App Component ---
        const App = () => {
            const [standardRules, setStandardRules] = useState([]);
            const [holidayCountry, setHolidayCountry] = useState('');
            const [holidayState, setHolidayState] = useState('');
            const [holidayMonthRules, setHolidayMonthRules] = useState([]);
            const [fetchedHolidays, setFetchedHolidays] = useState([]);
            const [fetchedHolidaysStatus, setFetchedHolidaysStatus] = useState('Awaiting country/state input...');
            const [overrideRules, setOverrideRules] = useState([]);
            const [jsonOutput, setJsonOutput] = useState('');
            const [statusMessage, setStatusMessage] = useState({ text: '', isError: false });
            
            const [counters, setCounters] = useState({
                standardRule: 0, holidayRule: 0, overrideRule: 0, 
                weekdayGroup: 0, ratePeriod: 0, dateEntry: 0,
            });

            const [selectedWeekStart, setSelectedWeekStart] = useState(() => {
                const today = new Date();
                const dayOfWeek = today.getDay(); 
                const diff = today.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); 
                return new Date(today.setDate(diff)).toISOString().split('T')[0]; 
            });

            const getNextId = useCallback((type) => {
                const nextVal = counters[type] + 1;
                setCounters(prev => ({ ...prev, [type]: nextVal }));
                return `${type}-${nextVal}-${Date.now()}`; 
            }, [counters]); 
            
            const clearAllConfigurations = useCallback(() => {
                setStandardRules([]);
                setHolidayCountry('');
                setHolidayState('');
                setHolidayMonthRules([]);
                setOverrideRules([]);
                setFetchedHolidays([]);
                setFetchedHolidaysStatus('Awaiting country/state input...');
                setJsonOutput('');
                setStatusMessage({ text: '', isError: false });
                setCounters({ standardRule: 0, holidayRule: 0, overrideRule: 0, weekdayGroup: 0, ratePeriod: 0, dateEntry: 0 });
            }, []);

            const addStandardRule = () => {
                const newRule = { 
                    id: getNextId('standardRule'), 
                    number: counters.standardRule + 1, 
                    months: [], 
                    weekdayGroups: [{ id: getNextId('weekdayGroup'), weekdays: [], ratePeriods: [{ id: getNextId('ratePeriod'), start: "00:00", end: "00:00", amount: 0.00 }] }]
                };
                setStandardRules(prev => [...prev, newRule]);
            };
            const updateStandardRule = (updatedRule) => {
                setStandardRules(prev => prev.map(r => r.id === updatedRule.id ? updatedRule : r));
            };
            const removeStandardRule = (ruleId) => {
                setStandardRules(prev => prev.filter(r => r.id !== ruleId));
            };

            const addHolidayMonthRule = () => {
                const newRule = { 
                    id: getNextId('holidayRule'), 
                    number: counters.holidayRule + 1, 
                    months: [], 
                    weekdayGroups: [{ id: getNextId('weekdayGroup'), weekdays: [], ratePeriods: [{ id: getNextId('ratePeriod'), start: "00:00", end: "00:00", amount: 0.00 }] }]
                };
                setHolidayMonthRules(prev => [...prev, newRule]);
            };
            const updateHolidayMonthRule = (updatedRule) => {
                setHolidayMonthRules(prev => prev.map(r => r.id === updatedRule.id ? updatedRule : r));
            };
            const removeHolidayMonthRule = (ruleId) => {
                setHolidayMonthRules(prev => prev.filter(r => r.id !== ruleId));
            };
            
            const addOverrideRuleHandler = () => {
                const newRule = {
                    id: getNextId('overrideRule'),
                    number: counters.overrideRule + 1,
                    dates: [{ id: getNextId('dateEntry'), month: '', days: [] }],
                    ratePeriods: [{ id: getNextId('ratePeriod'), start: "00:00", end: "00:00", amount: 0.00 }]
                };
                setOverrideRules(prev => [...prev, newRule]);
            };
            const updateOverrideRule = (updatedRule) => {
                setOverrideRules(prev => prev.map(r => r.id === updatedRule.id ? updatedRule : r));
            };
            const removeOverrideRule = (ruleId) => {
                setOverrideRules(prev => prev.filter(r => r.id !== ruleId));
            };

            const fetchHolidaysCallback = useCallback(debounce(async (country, state) => {
                if (!country) {
                    setFetchedHolidays([]);
                    setFetchedHolidaysStatus('Please enter a Country Code.');
                    return;
                }
                setFetchedHolidaysStatus('Fetching holidays...');
                try {
                    if (typeof window.Holidays !== 'function') {
                        setFetchedHolidaysStatus('Holiday library not loaded.');
                        console.error("window.Holidays is not a function");
                        return;
                    }
                    const hd = new window.Holidays(country, state || undefined);
                    const holidaysData = hd.getHolidays(new Date().getFullYear());
                    if (holidaysData && holidaysData.length > 0) {
                        setFetchedHolidays(holidaysData);
                        setFetchedHolidaysStatus(''); 
                    } else {
                        setFetchedHolidays([]);
                        setFetchedHolidaysStatus(`No holidays found for ${country}${state ? ` (${state})` : ''} or region not supported.`);
                    }
                } catch (error) {
                    console.error("Error fetching holidays:", error);
                    let errorMsg = `Error fetching for ${country}${state ? ` (${state})` : ''}.`;
                    if (error.message && error.message.includes('country is not supported')) errorMsg = `Country '${country}' not supported.`;
                    else if (error.message && error.message.includes('state is not supported')) errorMsg = `State '${state}' not supported for '${country}'.`;
                    setFetchedHolidays([]);
                    setFetchedHolidaysStatus(errorMsg);
                }
            }, 500), []); 

            useEffect(() => {
                if (holidayCountry) { 
                    fetchHolidaysCallback(holidayCountry, holidayState);
                } else {
                     setFetchedHolidays([]);
                     setFetchedHolidaysStatus('Awaiting country/state input...');
                }
            }, [holidayCountry, holidayState, fetchHolidaysCallback]);

            const validateTimeRangesForReact = useCallback((rateTimeranges, contextMessage) => {
                if (!rateTimeranges || rateTimeranges.length === 0) {
                    return `${contextMessage}: No rate time ranges defined. Full day coverage is required.`;
                }
                const minuteCoverage = new Array(MINUTES_IN_DAY).fill(0);
                for (const r of rateTimeranges) {
                    if (!r.start || !r.end) return `${contextMessage}: A rate period is missing a start or end time.`;
                    let startMinutes = timeStringToMinutes(r.start);
                    let endMinutes = timeStringToMinutes(r.end);
                    if (startMinutes % 30 !== 0) return `${contextMessage}: Start time ${r.start} must be on a :00 or :30 mark.`;
                    if (r.end !== "00:00" && (endMinutes % 30 !== 0)) return `${contextMessage}: End time ${r.end} must be on a :00 or :30 mark (or be "00:00" for end of day).`;
                    
                    let effectiveEndMinutes = (r.end === "00:00") ? MINUTES_IN_DAY : endMinutes;
            
                    if (startMinutes === 0 && effectiveEndMinutes === MINUTES_IN_DAY) {
                        for (let m = 0; m < MINUTES_IN_DAY; m++) minuteCoverage[m]++;
                        if (rateTimeranges.length === 1) continue; 
                    } else if (startMinutes >= effectiveEndMinutes && !(startMinutes > endMinutes && effectiveEndMinutes !== MINUTES_IN_DAY) ) {
                         return `${contextMessage}: Period ${r.start}-${r.end} has zero or negative duration.`;
                    }
            
                    if (startMinutes < effectiveEndMinutes) {
                        for (let m = startMinutes; m < effectiveEndMinutes; m++) minuteCoverage[m]++;
                    } else { 
                        for (let m = startMinutes; m < MINUTES_IN_DAY; m++) minuteCoverage[m]++;
                        for (let m = 0; m < effectiveEndMinutes; m++) minuteCoverage[m]++; 
                    }
                }
                for (let m = 0; m < MINUTES_IN_DAY; m++) {
                    if (minuteCoverage[m] === 0) return `${contextMessage}: Gap in time coverage at ${formatTimeForDisplay(m)}.`;
                    if (minuteCoverage[m] > 1) return `${contextMessage}: Overlapping time periods detected around ${formatTimeForDisplay(m)}.`;
                }
                return null;
            }, []);

            const parseAndValidateRuleSetForReact = useCallback((rules, ruleTypeLabel, validationErrors, overallCoveredMonthsSet) => {
                const rulesOutput = [];
                rules.forEach(rule => {
                    const contextPrefix = `${ruleTypeLabel} #${rule.number}`;
                    if (rule.months.length === 0) { validationErrors.push(`${contextPrefix} has no months selected.`); return; }
                    
                    rule.months.forEach(month => {
                        if (overallCoveredMonthsSet.has(month)) {
                            validationErrors.push(`Conflict: Month ${MONTHS_DATA.find(m=>m.value===month)?.name} (in ${ruleTypeLabel} #${rule.number}) is already assigned in another ${ruleTypeLabel} rule.`);
                        }
                        overallCoveredMonthsSet.add(month);
                    });

                    const weekStructureForRule = [];
                    if (rule.weekdayGroups.length === 0 && rule.months.length > 0) {
                        validationErrors.push(`${contextPrefix} (Months: ${rule.months.join(', ')}): No Weekday Groups defined.`);
                    }
                    let weekdaysCoveredInThisRule = new Set();
                    rule.weekdayGroups.forEach(group => {
                        const groupContext = `${contextPrefix}, Weekday Group (ID: ${group.id.slice(-5)})`;
                        if (group.weekdays.length === 0) { validationErrors.push(`${groupContext}: No weekdays selected.`); return; }
                        
                        group.weekdays.forEach(wd => {
                            if (weekdaysCoveredInThisRule.has(wd)) {
                                validationErrors.push(`Conflict in ${contextPrefix}: Weekday ${WEEKDAYS_DATA.find(d=>d.value===wd)?.name} is in multiple Weekday Groups.`);
                            }
                            weekdaysCoveredInThisRule.add(wd);
                        });

                        if (group.ratePeriods.length === 0 && group.weekdays.length > 0) {
                            validationErrors.push(`${groupContext} for days [${group.weekdays.map(val => WEEKDAYS_DATA.find(d=>d.value===val)?.name).join(', ')}]: No rate time ranges defined.`);
                        }
                        const timeValidationError = validateTimeRangesForReact(group.ratePeriods, groupContext);
                        if (timeValidationError) validationErrors.push(timeValidationError);

                        if (group.ratePeriods.length > 0 && !timeValidationError) {
                            weekStructureForRule.push({ 
                                iso_weekday: [...group.weekdays].sort((a,b)=>a-b), 
                                day_structure: { rate_timeranges: group.ratePeriods.map(({id, ...rest}) => rest) } 
                            });
                        }
                    });
                    const missingWeekdaysInRule = ALL_WEEKDAY_NUMBERS.filter(wd => !weekdaysCoveredInThisRule.has(wd));
                    if (missingWeekdaysInRule.length > 0 && rule.months.length > 0) {
                        validationErrors.push(`${contextPrefix} (Months: ${rule.months.map(val=>MONTHS_DATA.find(m=>m.value===val)?.name).join(', ')}): Weekdays [${missingWeekdaysInRule.map(val => WEEKDAYS_DATA.find(d=>d.value===val)?.name).join(', ')}] are not covered.`);
                    }
                    if (weekStructureForRule.length > 0) {
                        rulesOutput.push({ month: [...rule.months].sort((a,b)=>a-b), week_structure: weekStructureForRule });
                    }
                });
                return rulesOutput;
            }, [validateTimeRangesForReact]);


            const handleGenerateJson = useCallback(() => {
                let validationErrors = [];
                const finalJson = {};
                
                let overallStandardMonthsCovered = new Set();
                const parsedStandardRules = parseAndValidateRuleSetForReact(standardRules, 'Standard Tariff Rule', validationErrors, overallStandardMonthsCovered);
                if (parsedStandardRules.length > 0) finalJson.month_structure = parsedStandardRules;
                const missingStandardMonths = ALL_MONTH_NUMBERS.filter(m => !overallStandardMonthsCovered.has(m));
                if (missingStandardMonths.length > 0) validationErrors.push(`Overall Standard Tariff: Months [${missingStandardMonths.map(val=>MONTHS_DATA.find(m=>m.value===val)?.name).join(', ')}] are not covered.`);
                if (standardRules.length === 0) validationErrors.push("No Standard Tariff Rules defined. At least one standard rule covering all months is required.");

                if (holidayMonthRules.length > 0 || holidayCountry || holidayState) {
                    if (!holidayCountry) validationErrors.push("Country Holidays: Country code is missing if holiday rules are defined or state is entered.");
                    let overallHolidayMonthsCovered = new Set();
                    const parsedHolidayRules = parseAndValidateRuleSetForReact(holidayMonthRules, 'Holiday Month Rule', validationErrors, overallHolidayMonthsCovered);
                    if (parsedHolidayRules.length > 0) {
                        finalJson.country_holidays = { country: holidayCountry };
                        if (holidayState) finalJson.country_holidays.state = holidayState;
                        finalJson.country_holidays.month_structure = parsedHolidayRules;
                        const missingHolidayMonths = ALL_MONTH_NUMBERS.filter(m => !overallHolidayMonthsCovered.has(m));
                        if (missingHolidayMonths.length > 0) validationErrors.push(`Country Holidays Definition: Months [${missingHolidayMonths.map(val=>MONTHS_DATA.find(m=>m.value===val)?.name).join(', ')}] are not covered within the holiday rules.`);
                    } else if (holidayMonthRules.length > 0 && holidayCountry) {
                        // Errors already pushed
                    }
                }

                const parsedOverrideRules = [];
                let allOverriddenDates = new Set();
                overrideRules.forEach(rule => {
                    const overrideContext = `Override Rule #${rule.number}`;
                    const annualDates = [];
                    if (rule.dates.length === 0) validationErrors.push(`${overrideContext}: No specific dates (month/day) defined.`);
                    rule.dates.forEach(entry => {
                        if (entry.month && entry.days.length > 0) {
                            entry.days.forEach(day => {
                                const dateKey = `${entry.month}-${day}`;
                                if (allOverriddenDates.has(dateKey)) validationErrors.push(`Conflict: Date ${MONTHS_DATA.find(m=>m.value===entry.month)?.name} ${day} is defined in multiple Override Rules or times.`);
                                allOverriddenDates.add(dateKey);
                            });
                            annualDates.push({ month: entry.month, days: [...entry.days].sort((a,b)=>a-b) });
                        } else if (entry.month || entry.days.length > 0) {
                            validationErrors.push(`${overrideContext}: Incomplete month/day entry found.`);
                        }
                    });
                    if (rule.ratePeriods.length === 0 && annualDates.length > 0) validationErrors.push(`${overrideContext}: No rate time ranges defined for the specified dates.`);
                    const timeValidationError = validateTimeRangesForReact(rule.ratePeriods, overrideContext);
                    if (timeValidationError) validationErrors.push(timeValidationError);
                    if (annualDates.length > 0 && rule.ratePeriods.length > 0 && !timeValidationError) {
                        parsedOverrideRules.push({ annual_date: annualDates, day_structure: { rate_timeranges: rule.ratePeriods.map(({id, ...rest}) => rest) } });
                    }
                });
                if (parsedOverrideRules.length > 0) finalJson.override = parsedOverrideRules;

                if (validationErrors.length > 0) {
                    setStatusMessage({ text: `Validation Errors Found (Fix and Regenerate):\n- ${validationErrors.join('\n- ')}`, isError: true });
                    setJsonOutput('');
                } else {
                    if (Object.keys(finalJson).length === 0 || !finalJson.month_structure) {
                        setStatusMessage({ text: "No valid tariff data to generate. Ensure at least standard tariff rules are fully configured and valid.", isError: true });
                        setJsonOutput('');
                    } else {
                        setJsonOutput(JSON.stringify(finalJson, null, 2));
                        setStatusMessage({ text: "JSON generated successfully after passing all validations!", isError: false });
                    }
                }
            }, [standardRules, holidayMonthRules, overrideRules, holidayCountry, holidayState, parseAndValidateRuleSetForReact, validateTimeRangesForReact]);
            
            // --- Example Loaders ---
            const loadFlatRateExample = useCallback(() => {
                clearAllConfigurations();
                setStandardRules([{ 
                    id: 'std-flat-1', number: 1, months: [...ALL_MONTH_NUMBERS], 
                    weekdayGroups: [{ id: 'std-flat-wg-1', weekdays: [...ALL_WEEKDAY_NUMBERS], ratePeriods: [{id: 'std-flat-rp-1', start: "00:00", end: "00:00", amount: 0.15 }] }]
                }]);
                setStatusMessage({ text: "Flat Rate example loaded.", isError: false });
            }, [clearAllConfigurations]);

            const loadDualRateExample = useCallback(() => {
                clearAllConfigurations();
                setStandardRules([{
                    id: 'std-dual-1', number: 1, months: [...ALL_MONTH_NUMBERS],
                    weekdayGroups: [{
                        id: 'std-dual-wg-1', weekdays: [...ALL_WEEKDAY_NUMBERS],
                        ratePeriods: [
                            { id: 'std-dual-rp-1', start: "00:00", end: "07:00", amount: 0.10 },
                            { id: 'std-dual-rp-2', start: "07:00", end: "00:00", amount: 0.25 }
                        ]
                    }]
                }]);
                setStatusMessage({ text: "Dual Rate example loaded.", isError: false });
            }, [clearAllConfigurations]);

            const loadDualRateWeekendsOffpeakExample = useCallback(() => {
                clearAllConfigurations();
                setStandardRules([{
                    id: 'std-dualwknd-1', number: 1, months: [...ALL_MONTH_NUMBERS],
                    weekdayGroups: [
                        { 
                            id: 'std-dualwknd-wg-1', weekdays: [1,2,3,4,5], 
                            ratePeriods: [
                                { id: 'std-dualwknd-rp-1', start: "00:00", end: "07:00", amount: 0.10 },
                                { id: 'std-dualwknd-rp-2', start: "07:00", end: "00:00", amount: 0.25 }
                            ]
                        },
                        {
                            id: 'std-dualwknd-wg-2', weekdays: [6,7],
                            ratePeriods: [{ id: 'std-dualwknd-rp-3', start: "00:00", end: "00:00", amount: 0.10 }]
                        }
                    ]
                }]);
                setStatusMessage({ text: "Dual Rate (Weekends Off-peak) example loaded.", isError: false });
            }, [clearAllConfigurations]);
            
            const loadFullyComplicatedExample = useCallback(() => {
                clearAllConfigurations();
                setStandardRules([
                    { 
                        id: 'std-comp-1', number: 1, months: [1, 2, 3, 10, 11, 12], 
                        weekdayGroups: [
                            { id: 'std-comp-wg-1', weekdays: [1,2,3,4,5], ratePeriods: [{ id: 'std-comp-rp-1', start: "00:00", end: "12:00", amount: 0.10 }, { id: 'std-comp-rp-2', start: "12:00", end: "00:00", amount: 0.20 }] },
                            { id: 'std-comp-wg-2', weekdays: [6,7], ratePeriods: [{ id: 'std-comp-rp-3', start: "00:00", end: "00:00", amount: 0.10 }] }
                        ]
                    },
                    {
                        id: 'std-comp-2', number: 2, months: [4,5,6,7,8,9],
                        weekdayGroups: [{ id: 'std-comp-wg-3', weekdays: [...ALL_WEEKDAY_NUMBERS], ratePeriods: [{ id: 'std-comp-rp-4', start: "00:00", end: "00:00", amount: 0.10 }]}]
                    }
                ]);
                setHolidayCountry("AU");
                setHolidayState("ACT");
                setHolidayMonthRules([
                    { id: 'hol-comp-1', number: 1, months: [1], weekdayGroups: [{id: 'hol-comp-wg-1', weekdays: [...ALL_WEEKDAY_NUMBERS], ratePeriods: [{id: 'hol-comp-rp-1', start:"00:00", end:"00:00", amount: 0.01}] }]},
                    { id: 'hol-comp-2', number: 2, months: [2,3,4,5,6,7,8,9,10,11,12], weekdayGroups: [{id: 'hol-comp-wg-2', weekdays: [...ALL_WEEKDAY_NUMBERS], ratePeriods: [{id: 'hol-comp-rp-2', start:"00:00", end:"00:00", amount: 0.02}] }]}
                ]);
                setOverrideRules([{
                    id: 'ovr-comp-1', number: 1,
                    dates: [ {id: 'ovr-dt-1', month: 12, days: [25,31]}, {id: 'ovr-dt-2', month: 2, days: [29]} ],
                    ratePeriods: [{id: 'ovr-rp-1', start: "00:00", end: "00:00", amount: 0.10}]
                }]);
                setStatusMessage({ text: "Fully Complicated example loaded.", isError: false });
            }, [clearAllConfigurations]);
            
            useEffect(() => { 
                handleGenerateJson();
            }, [standardRules, holidayMonthRules, overrideRules, holidayCountry, holidayState, handleGenerateJson]);

            useEffect(() => {
                loadFlatRateExample(); 
            }, [loadFlatRateExample]); 

            // --- Chart Data Generation ---
            const chartData = useMemo(() => {
                const weekStart = new Date(selectedWeekStart + "T00:00:00"); 
                const labels = [];
                const dataPoints = [];
                let currentHolidays = [];

                if (holidayCountry && window.Holidays) {
                    try {
                        const hd = new window.Holidays(holidayCountry, holidayState || undefined);
                        currentHolidays = hd.getHolidays(weekStart.getFullYear());
                        if (new Date(weekStart.getFullYear(), weekStart.getMonth(), weekStart.getDate() + 6).getFullYear() > weekStart.getFullYear()) {
                            currentHolidays = currentHolidays.concat(hd.getHolidays(weekStart.getFullYear() + 1));
                        }
                    } catch (e) { console.warn("Could not fetch holidays for chart:", e); }
                }
                
                for (let dayOffset = 0; dayOffset < 7; dayOffset++) {
                    const currentDate = new Date(weekStart);
                    currentDate.setDate(weekStart.getDate() + dayOffset);
                    const currentMonth = currentDate.getMonth() + 1; 
                    const currentDayOfMonth = currentDate.getDate();
                    let currentIsoWeekday = currentDate.getDay(); 
                    if (currentIsoWeekday === 0) currentIsoWeekday = 7; 

                    const dateStringForHolidayCheck = `${currentDate.getFullYear()}-${String(currentMonth).padStart(2,'0')}-${String(currentDayOfMonth).padStart(2,'0')}`;
                    const isHoliday = currentHolidays.some(h => h.date.startsWith(dateStringForHolidayCheck));

                    for (let interval = 0; interval < 48; interval++) { 
                        const minutesIntoDay = interval * 30;
                        const timeLabel = formatTimeForDisplay(minutesIntoDay);
                        const dayLabel = WEEKDAYS_DATA.find(wd => wd.value === currentIsoWeekday)?.name.substring(0,3) || 'Day';
                        labels.push(`${dayLabel} ${timeLabel}`);

                        let rate = null;

                        const activeOverride = overrideRules.find(or => 
                            or.dates.some(d => d.month === currentMonth && d.days.includes(currentDayOfMonth))
                        );
                        if (activeOverride) {
                            for (const rp of activeOverride.ratePeriods) {
                                const startM = timeStringToMinutes(rp.start);
                                const endM = (rp.end === "00:00") ? MINUTES_IN_DAY : timeStringToMinutes(rp.end);
                                if (startM <= minutesIntoDay && minutesIntoDay < endM) { rate = rp.amount; break; } 
                                else if (startM > endM && (minutesIntoDay >= startM || minutesIntoDay < endM)) { rate = rp.amount; break; }
                            }
                        }

                        if (rate === null && isHoliday && holidayCountry) {
                             const applicableHolidayRule = holidayMonthRules.find(hr => hr.months.includes(currentMonth));
                             if(applicableHolidayRule) {
                                const applicableWeekdayGroup = applicableHolidayRule.weekdayGroups.find(wg => wg.weekdays.includes(currentIsoWeekday));
                                if(applicableWeekdayGroup) {
                                    for (const rp of applicableWeekdayGroup.ratePeriods) {
                                        const startM = timeStringToMinutes(rp.start);
                                        const endM = (rp.end === "00:00") ? MINUTES_IN_DAY : timeStringToMinutes(rp.end);
                                        if (startM <= minutesIntoDay && minutesIntoDay < endM) { rate = rp.amount; break; } 
                                        else if (startM > endM && (minutesIntoDay >= startM || minutesIntoDay < endM)) { rate = rp.amount; break; }
                                    }
                                }
                             }
                        }
                        
                        if (rate === null) {
                            const applicableStandardRule = standardRules.find(sr => sr.months.includes(currentMonth));
                            if(applicableStandardRule) {
                                const applicableWeekdayGroup = applicableStandardRule.weekdayGroups.find(wg => wg.weekdays.includes(currentIsoWeekday));
                                if(applicableWeekdayGroup) {
                                     for (const rp of applicableWeekdayGroup.ratePeriods) {
                                        const startM = timeStringToMinutes(rp.start);
                                        const endM = (rp.end === "00:00") ? MINUTES_IN_DAY : timeStringToMinutes(rp.end);
                                        if (startM <= minutesIntoDay && minutesIntoDay < endM) { rate = rp.amount; break; } 
                                        else if (startM > endM && (minutesIntoDay >= startM || minutesIntoDay < endM)) { rate = rp.amount; break; }
                                    }
                                }
                            }
                        }
                        dataPoints.push(rate !== null ? rate : 0); 
                    }
                }
                return { labels, data: dataPoints };
            }, [selectedWeekStart, standardRules, holidayMonthRules, overrideRules, holidayCountry, holidayState, fetchedHolidays]); 


            return (
                <div className="max-w-6xl mx-auto bg-white p-6 md:p-8 rounded-xl shadow-2xl">
                    <header className="mb-10 text-center">
                        <h1 className="text-4xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-indigo-600">Comprehensive Tariff Designer</h1>
                        <p className="text-gray-600 mt-3 text-lg">Define standard rates, country-specific holidays, and date overrides with full validation.</p>
                    </header>

                    <section className="section-container mb-10 bg-indigo-50 border-indigo-200">
                        <h2 className="section-header text-indigo-700 border-indigo-400">Quick Start Examples</h2>
                        <p className="text-sm text-gray-600 mb-6">Select an example to pre-fill the designer. This will clear any current configuration.</p>
                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                            <button onClick={loadFlatRateExample} className="quick-start-btn">Flat Rate</button>
                            <button onClick={loadDualRateExample} className="quick-start-btn">Dual Rate</button>
                            <button onClick={loadDualRateWeekendsOffpeakExample} className="quick-start-btn">Dual Rate (Weekend Off-peak)</button>
                            <button onClick={loadFullyComplicatedExample} className="quick-start-btn">Fully Complicated Example</button>
                        </div>
                    </section>

                    {/* Rate Preview Chart Section */}
                    <section className="section-container">
                        <h2 className="section-header">Rate Preview Chart</h2>
                        <div className="mb-4">
                            <label htmlFor="weekPicker" className="input-label">Select Week Start Date:</label>
                            <input 
                                type="date" 
                                id="weekPicker"
                                value={selectedWeekStart}
                                onChange={(e) => setSelectedWeekStart(e.target.value)}
                                className="input-field w-full md:w-1/3"
                            />
                        </div>
                        <RatePreviewChart chartData={chartData} selectedWeekStartForChart={selectedWeekStart} />
                    </section>


                    <section className="section-container">
                        <h2 className="section-header">Standard Tariff Rules</h2>
                        <div id="tariffRulesContainerReact" className="space-y-6 mb-6"> 
                            {standardRules.map(rule => (
                                <MonthRuleSet 
                                    key={rule.id} 
                                    rule={rule} 
                                    type="standard"
                                    onUpdateRule={updateStandardRule}
                                    onRemoveRule={() => removeStandardRule(rule.id)}
                                />
                            ))}
                        </div>
                        <button onClick={addStandardRule} className="add-btn w-full sm:w-auto">+ Add Standard Tariff Rule</button>
                    </section>

                    <section className="section-container">
                        <h2 className="section-header">Country Holidays</h2>
                        <div id="countryHolidaysConfigReact" className="mb-6 p-4 border border-dashed border-blue-300 rounded-lg bg-blue-50"> 
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label htmlFor="holidayCountryReact" className="input-label">Country Code (e.g., AU):</label>
                                    <input type="text" id="holidayCountryReact" className="input-field" placeholder="AU" value={holidayCountry} onChange={e => setHolidayCountry(e.target.value.toUpperCase())} />
                                </div>
                                <div>
                                    <label htmlFor="holidayStateReact" className="input-label">State/Region Code (Optional, e.g., ACT):</label>
                                    <input type="text" id="holidayStateReact" className="input-field" placeholder="ACT" value={holidayState} onChange={e => setHolidayState(e.target.value.toUpperCase())} />
                                </div>
                            </div>
                            <div id="fetchedHolidaysListContainerReact" className="mt-4"> 
                                <p className="text-sm text-gray-600 mb-1">Recognized public holidays for {new Date(selectedWeekStart).getFullYear()}:</p>
                                <div id="fetchedHolidaysListReact" className="text-xs max-h-32 overflow-y-auto bg-indigo-100 p-2 rounded"> 
                                    {fetchedHolidaysStatus && <p className="text-gray-500">{fetchedHolidaysStatus}</p>}
                                    {fetchedHolidays.length > 0 && (
                                        <ul className="list-disc list-inside space-y-0.5">
                                            {fetchedHolidays.map(h => (
                                                <li key={h.date}><strong>{new Date(h.date).toLocaleDateString(undefined, {month:'short', day:'numeric'})}:</strong> {h.name}</li>
                                            ))}
                                        </ul>
                                    )}
                                </div>
                            </div>
                            <p className="text-sm text-gray-600 mb-1 mt-4">Define specific rate structures for holidays within the selected country/state.</p>
                        </div>
                        <div id="holidayMonthRulesContainerReact" className="space-y-6 mb-6"> 
                             {holidayMonthRules.map(rule => (
                                <MonthRuleSet 
                                    key={rule.id} 
                                    rule={rule} 
                                    type="holiday"
                                    onUpdateRule={updateHolidayMonthRule}
                                    onRemoveRule={() => removeHolidayMonthRule(rule.id)}
                                />
                            ))}
                        </div>
                        <button onClick={addHolidayMonthRule} className="add-btn w-full sm:w-auto bg-blue-500 hover:bg-blue-600">+ Add Holiday Month Rule</button>
                    </section>

                    <section className="section-container">
                        <h2 className="section-header">Override Specific Days</h2>
                        <p className="text-sm text-gray-600 mb-4">Define special rates for specific calendar dates (e.g., Christmas, New Year's Eve).</p>
                        <div id="overrideRulesContainerReact" className="space-y-6 mb-6"> 
                            {overrideRules.map(rule => (
                                <OverrideRule 
                                    key={rule.id}
                                    rule={rule}
                                    onUpdateRule={updateOverrideRule}
                                    onRemoveRule={() => removeOverrideRule(rule.id)}
                                />
                            ))}
                        </div>
                        <button onClick={addOverrideRuleHandler} className="add-btn w-full sm:w-auto bg-purple-500 hover:bg-purple-600">+ Add Override Day Rule</button>
                    </section>

                    <section className="mt-10 p-6 bg-gray-50 rounded-lg shadow-inner">
                        <h2 className="subsection-title text-xl mb-4 text-gray-700 border-b pb-2">Generate & View JSON</h2>
                        <div className="flex flex-col sm:flex-row gap-4 mb-4">
                            <button onClick={handleGenerateJson} className="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-150 ease-in-out text-lg">Validate & Generate JSON</button>
                            <button 
                                onClick={() => {
                                    if (typeof window.copyJsonToClipboardGlobal === 'function') {
                                        window.copyJsonToClipboardGlobal(jsonOutput, setStatusMessage); 
                                    } else {
                                        console.error("Global copy function not defined");
                                        setStatusMessage({text: "Copy function error. See console.", isError: true});
                                    }
                                }} 
                                className="flex-1 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-150 ease-in-out text-lg" 
                                disabled={!jsonOutput}
                            >
                                Copy JSON to Clipboard
                            </button>
                        </div>
                        {statusMessage.text && (
                             <div 
                                id="statusMessageReact" 
                                className={`mb-2 text-sm font-medium text-center p-2 rounded-md ${statusMessage.isError ? 'text-red-700 bg-red-100 border border-red-300 text-left' : 'text-green-700 bg-green-100 border border-green-300'}`}
                                dangerouslySetInnerHTML={{ __html: statusMessage.text.replace(/\n/g, '<br>') }}
                             />
                        )}
                        <textarea id="jsonOutputReact" rows="20" className="w-full p-4 border border-gray-300 rounded-md bg-gray-100 text-sm font-mono focus:ring-2 focus:ring-blue-500 focus:border-blue-500" value={jsonOutput} readOnly placeholder="JSON output will appear here after successful validation..."></textarea>
                    </section>

                    <footer className="text-center text-sm text-gray-500 mt-12">
                        <p>&copy; <span id="currentYearReact">{new Date().getFullYear()}</span> Tariff Designer Interface. Internal Use Only.</p>
                    </footer>
                </div>
            );
        };

        window.showStatusMessageGlobal = (message, isError, reactSetStatusMessage) => {
            if (reactSetStatusMessage) { 
                reactSetStatusMessage({text: message, isError: isError });
            } else { 
                const statusDiv = document.getElementById('statusMessageReact') || document.getElementById('statusMessage');
                if (statusDiv) {
                    statusDiv.innerHTML = message.replace(/\n/g, '<br>');
                    statusDiv.className = `mb-2 text-sm font-medium text-center p-2 rounded-md ${isError ? 'text-red-700 bg-red-100 border border-red-300 text-left' : 'text-green-700 bg-green-100 border border-green-300'}`;
                    if (!isError) {
                        setTimeout(() => {
                            if (statusDiv.innerHTML === message.replace(/\n/g, '<br>') && !statusDiv.classList.contains('text-red-700')) {
                                statusDiv.textContent = '';
                                statusDiv.className = 'mb-2 text-sm font-medium text-center p-2 rounded-md';
                            }
                        }, 7000);
                    }
                }
            }
        };

        window.copyJsonToClipboardGlobal = (textToCopy, reactSetStatusMessage) => {
            const showStatus = (msg, isErr) => window.showStatusMessageGlobal(msg, isErr, reactSetStatusMessage);
            if (!textToCopy) {
                showStatus("Nothing to copy. Generate JSON first.", true);
                return;
            }
            if (!navigator.clipboard) {
                 showStatus("Clipboard API not available.", true);
                return;
            }
            navigator.clipboard.writeText(textToCopy)
                .then(() => {
                     showStatus("JSON copied to clipboard!", false);
                })
                .catch(err => {
                    console.error('Clipboard copy error:', err);
                    let userErrorMessage = "Failed to copy JSON. Please check the browser console for more details.";
                    if (err && err.name === "NotAllowedError") {
                        userErrorMessage = `<b>Clipboard Error:</b> ${err.message} <br/>This usually means the action was blocked by a <b>permissions policy</b>.`;
                        if (!window.isSecureContext) {
                            userErrorMessage += "<br/>Ensure the page is served over a secure context (<b>HTTPS</b> or <b>localhost</b>).";
                        } else {
                            userErrorMessage += "<br/>Check browser settings for clipboard permissions for this site, or try focusing the document before copying.";
                        }
                         userErrorMessage += "<br/>You may need to <a href='https://developer.mozilla.org/en-US/docs/Web/API/Clipboard/writeText#browser_compatibility' target='_blank' class='text-blue-600 hover:underline'>check browser compatibility and requirements</a> or copy the text manually.";
                    } else if (err && err.message) { 
                        userErrorMessage = `Failed to copy: ${err.name || 'Error'} - ${err.message}`;
                    }
                    showStatus(userErrorMessage, true);
                });
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>

</body>
</html>
